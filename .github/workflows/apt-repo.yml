# Huanvae Chat APT ä»“åº“è‡ªåŠ¨æ›´æ–°
#
# å½“æ–°ç‰ˆæœ¬å‘å¸ƒåè‡ªåŠ¨æ›´æ–° APT ä»“åº“ç´¢å¼•
# ç”¨æˆ·å¯é€šè¿‡ apt upgrade è·å–æ›´æ–°
#
# ä½¿ç”¨æ–¹æ³•ï¼š
# 1. ç”Ÿæˆ GPG å¯†é’¥å¹¶æ·»åŠ åˆ° GitHub Secrets (APT_GPG_PRIVATE_KEY)
# 2. å¯ç”¨ GitHub Pages (gh-pages åˆ†æ”¯)
# 3. Release workflow å®Œæˆåè‡ªåŠ¨è§¦å‘
#
# è§¦å‘æœºåˆ¶è¯´æ˜ï¼š
# - GITHUB_TOKEN åˆ›å»ºçš„äº‹ä»¶ä¸ä¼šè§¦å‘å…¶ä»– workflowï¼ˆå®˜æ–¹è®¾è®¡ï¼Œé˜²æ­¢æ— é™é€’å½’ï¼‰
# - å› æ­¤ä½¿ç”¨ workflow_run ç›‘å¬ Release workflow å®Œæˆåè§¦å‘
# - å‚è€ƒï¼šhttps://docs.github.com/en/actions/using-workflows/triggering-a-workflow

name: Update APT Repository

on:
  # ç›‘å¬ Release workflow å®Œæˆåè§¦å‘ï¼ˆè§£å†³ GITHUB_TOKEN ä¸è§¦å‘å…¶ä»– workflow çš„é—®é¢˜ï¼‰
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘é€‰é¡¹
  workflow_dispatch:

jobs:
  update-apt-repo:
    runs-on: ubuntu-latest
    # ä»…å½“ Release workflow æˆåŠŸå®Œæˆæ—¶è¿è¡Œï¼ˆæˆ–æ‰‹åŠ¨è§¦å‘æ—¶ï¼‰
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0
        continue-on-error: true

      - name: Initialize gh-pages if not exists
        run: |
          if [ ! -d ".git" ]; then
            git init
            git remote add origin https://github.com/${{ github.repository }}.git
            git checkout -b gh-pages
          fi
          mkdir -p pool/main/h/huanvae-chat
          mkdir -p dists/stable/main/binary-amd64

      - name: Import GPG key
        env:
          APT_GPG_PRIVATE_KEY: ${{ secrets.APT_GPG_PRIVATE_KEY }}
        run: |
          if [ -n "$APT_GPG_PRIVATE_KEY" ]; then
            echo "$APT_GPG_PRIVATE_KEY" | gpg --batch --import
            GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | head -1 | awk '{print $2}' | cut -d'/' -f2)
            echo "GPG_KEY_ID=$GPG_KEY_ID" >> $GITHUB_ENV
            echo "HAS_GPG=true" >> $GITHUB_ENV
          else
            echo "No GPG key configured, skipping signing"
            echo "HAS_GPG=false" >> $GITHUB_ENV
          fi

      - name: Download latest deb from release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p pool/main/h/huanvae-chat/
          
          # æ¸…ç†æ—§çš„ deb æ–‡ä»¶
          rm -f pool/main/h/huanvae-chat/*.deb
          
          # ä¸‹è½½æœ€æ–° release çš„ deb
          gh release download --pattern "*_amd64.deb" \
            -D pool/main/h/huanvae-chat/ \
            -R ${{ github.repository }} || echo "No deb found"
          
          echo "Downloaded packages:"
          ls -la pool/main/h/huanvae-chat/ || true

      - name: Generate APT repository metadata
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰ deb æ–‡ä»¶
          if ! ls pool/main/h/huanvae-chat/*.deb 1> /dev/null 2>&1; then
            echo "No deb files found, skipping metadata generation"
            exit 0
          fi
          
          # åˆ›å»ºç›®å½•ç»“æ„
          mkdir -p dists/stable/main/binary-amd64
          
          # ç”Ÿæˆ Packages ç´¢å¼•
          dpkg-scanpackages --multiversion pool/ > dists/stable/main/binary-amd64/Packages
          gzip -k -f dists/stable/main/binary-amd64/Packages
          xz -k -f dists/stable/main/binary-amd64/Packages
          
          # ç”Ÿæˆ Release æ–‡ä»¶
          cd dists/stable
          
          cat > Release << EOF
          Origin: Huanvae Chat
          Label: Huanvae Chat
          Suite: stable
          Codename: stable
          Architectures: amd64
          Components: main
          Description: Huanvae Chat APT Repository
          Date: $(date -Ru)
          EOF
          
          # è®¡ç®—æ ¡éªŒå’Œ
          {
            echo "MD5Sum:"
            find main -type f | while read f; do
              echo " $(md5sum "$f" | cut -d' ' -f1) $(stat -c%s "$f") $f"
            done
            echo "SHA256:"
            find main -type f | while read f; do
              echo " $(sha256sum "$f" | cut -d' ' -f1) $(stat -c%s "$f") $f"
            done
          } >> Release
          
          cd ../..
          
          echo "Repository structure:"
          find dists/ -type f

      - name: Sign repository
        if: env.HAS_GPG == 'true'
        run: |
          cd dists/stable
          gpg --batch --yes --armor --detach-sign -o Release.gpg Release
          gpg --batch --yes --armor --clearsign -o InRelease Release
          cd ../..
          
          # å¯¼å‡ºå…¬é’¥
          gpg --armor --export ${{ env.GPG_KEY_ID }} > gpg.key

      - name: Create install script
        run: |
          cat > install.sh << 'SCRIPT'
          #!/bin/bash
          set -e
          
          REPO_URL="https://huanwei520.github.io/Huanvae-Chat-App"
          
          echo "ğŸš€ æ·»åŠ  Huanvae Chat APT ä»“åº“..."
          
          # ä¸‹è½½å¹¶å®‰è£… GPG å¯†é’¥
          curl -fsSL "${REPO_URL}/gpg.key" | \
            sudo gpg --dearmor -o /usr/share/keyrings/huanvae-chat.gpg
          
          # æ·»åŠ ä»“åº“æºï¼ˆä»…æ”¯æŒ amd64 æ¶æ„ï¼‰
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/huanvae-chat.gpg] ${REPO_URL} stable main" | \
            sudo tee /etc/apt/sources.list.d/huanvae-chat.list > /dev/null
          
          # æ›´æ–°å¹¶å®‰è£…
          sudo apt update
          sudo apt install -y huanvae-chat-app
          
          echo ""
          echo "âœ… å®‰è£…å®Œæˆï¼"
          echo "   è¿è¡Œ: huanvae-chat"
          echo "   æ›´æ–°: sudo apt update && sudo apt upgrade"
          SCRIPT
          chmod +x install.sh

      - name: Update README
        run: |
          cat > README.md << 'EOF'
          # Huanvae Chat APT Repository

          ## ä¸€é”®å®‰è£…

          ```bash
          curl -fsSL https://huanwei520.github.io/Huanvae-Chat-App/install.sh | bash
          ```

          ## æ‰‹åŠ¨å®‰è£…

          ```bash
          # 1. æ·»åŠ  GPG å¯†é’¥
          curl -fsSL https://huanwei520.github.io/Huanvae-Chat-App/gpg.key | \
            sudo gpg --dearmor -o /usr/share/keyrings/huanvae-chat.gpg

          # 2. æ·»åŠ ä»“åº“æºï¼ˆä»…æ”¯æŒ amd64 æ¶æ„ï¼‰
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/huanvae-chat.gpg] https://huanwei520.github.io/Huanvae-Chat-App stable main" | \
            sudo tee /etc/apt/sources.list.d/huanvae-chat.list

          # 3. å®‰è£…
          sudo apt update
          sudo apt install huanvae-chat-app
          ```

          ## æ›´æ–°

          ```bash
          sudo apt update
          sudo apt upgrade
          ```

          ## å¸è½½

          ```bash
          sudo apt remove huanvae-chat-app
          sudo rm /etc/apt/sources.list.d/huanvae-chat.list
          sudo rm /usr/share/keyrings/huanvae-chat.gpg
          ```
          EOF

      - name: Commit and push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # æ£€æŸ¥æ˜¯å¦åœ¨ gh-pages åˆ†æ”¯
          CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "")
          
          if [ -z "$CURRENT_BRANCH" ] || [ "$CURRENT_BRANCH" != "gh-pages" ]; then
            # ä¸åœ¨ gh-pages åˆ†æ”¯ï¼Œéœ€è¦åˆ›å»ºæˆ–åˆ‡æ¢
            git checkout --orphan gh-pages 2>/dev/null || git checkout -B gh-pages
          fi
          
          git add -A
          git diff --staged --quiet || git commit -m "Update APT repository - $(date -u +%Y-%m-%d)"
          
          # å¼ºåˆ¶æ¨é€åˆ° gh-pagesï¼ˆé¦–æ¬¡åˆ›å»ºæˆ–æ›´æ–°ï¼‰
          git push --force "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" gh-pages
