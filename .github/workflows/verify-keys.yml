name: Verify Signing Keys

on:
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Extract public key from private key
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          echo "=== 当前 tauri.conf.json 中的公钥 ==="
          echo "Key ID: 3F91C30FA91A755A"
          echo "Public: RWRadRqpD8ORP5BYBcfv/hpRw3dnNOMdfS3dV7ejkC+lS9r8ReYaHClc"
          echo ""
          
          echo "=== 从私钥提取公钥 ==="
          
          # 检查私钥是否存在
          if [ -z "$TAURI_SIGNING_PRIVATE_KEY" ]; then
            echo "❌ 错误: TAURI_SIGNING_PRIVATE_KEY 未设置"
            exit 1
          fi
          
          # 解码私钥（私钥是 base64 编码的 minisign 格式）
          echo "$TAURI_SIGNING_PRIVATE_KEY" | base64 -d > /tmp/private.key 2>/dev/null || \
          echo "$TAURI_SIGNING_PRIVATE_KEY" > /tmp/private.key
          
          # 显示私钥的前两行（comment 和 key id，不包含实际密钥）
          echo "私钥文件头部信息:"
          head -2 /tmp/private.key
          
          # 安装 minisign
          sudo apt-get update && sudo apt-get install -y minisign
          
          # 尝试从私钥提取公钥信息
          echo ""
          echo "=== 使用 minisign 验证 ==="
          
          # 创建测试文件
          echo "test" > /tmp/test.txt
          
          # 尝试签名（如果私钥格式正确且密码正确）
          if [ -n "$TAURI_SIGNING_PRIVATE_KEY_PASSWORD" ]; then
            echo "$TAURI_SIGNING_PRIVATE_KEY_PASSWORD" | minisign -S -s /tmp/private.key -m /tmp/test.txt 2>&1 || echo "签名失败"
          else
            minisign -S -s /tmp/private.key -m /tmp/test.txt 2>&1 || echo "签名失败（可能需要密码）"
          fi
          
          # 如果签名成功，验证签名
          if [ -f /tmp/test.txt.minisig ]; then
            echo ""
            echo "✅ 签名成功，查看签名文件:"
            cat /tmp/test.txt.minisig
            echo ""
            echo "尝试用公钥验证:"
            # 创建完整格式的公钥文件（必须包含 comment 行）
            printf '%s\n' "untrusted comment: minisign public key: 3F91C30FA91A755A" "RWRadRqpD8ORP5BYBcfv/hpRw3dnNOMdfS3dV7ejkC+lS9r8ReYaHClc" > /tmp/public.key
            echo "公钥文件内容:"
            cat /tmp/public.key
            echo ""
            minisign -Vm /tmp/test.txt -p /tmp/public.key && echo "✅ 公钥匹配！" || echo "❌ 公钥不匹配！"
          fi
          
          # 清理
          rm -f /tmp/private.key /tmp/test.txt /tmp/test.txt.minisig /tmp/public.key
