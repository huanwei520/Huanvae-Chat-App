<?xml version="1.0" encoding="utf-8"?>
<!--
  Huanvae Chat - WiX 防火墙配置
  
  功能：为 MSI 安装包配置防火墙规则，使局域网文件传输功能无需手动配置
  
  添加的规则：
  - mDNS (UDP 5353) - 用于设备发现
  - 传输端口 (TCP 53317) - 用于文件传输
  - 应用程序规则 - 允许应用所有网络访问
  
  注意：
  - 需要 WiX Firewall Extension (WixFirewallExtension)
  - 规则在安装时自动添加，卸载时自动删除
  - Profile="private" 表示仅在专用网络生效（更安全）
  
  参考文档：
  - WiX Firewall Extension: https://wixtoolset.org/documentation/manual/v3/xsd/firewall/
  - Tauri WiX 配置: https://v2.tauri.app/reference/config/#wixconfig
-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:fire="http://schemas.microsoft.com/wix/FirewallExtension">
  
  <Fragment>
    <!-- 防火墙规则组件组 -->
    <ComponentGroup Id="FirewallComponents" Directory="INSTALLDIR">
      
      <!-- mDNS 防火墙规则 (UDP 5353) -->
      <Component Id="FirewallRule_mDNS" Guid="*">
        <fire:FirewallException
          Id="mDNSException"
          Name="Huanvae Chat mDNS"
          Protocol="udp"
          Port="5353"
          Profile="private"
          Scope="localSubnet"
          Description="Huanvae Chat 局域网设备发现 (mDNS)" />
        <!-- 需要一个 KeyPath，使用注册表键 -->
        <RegistryValue
          Root="HKCU"
          Key="Software\HuanvaeChat\Firewall"
          Name="mDNS"
          Type="integer"
          Value="1"
          KeyPath="yes" />
      </Component>
      
      <!-- 传输端口防火墙规则 (TCP 53317) -->
      <Component Id="FirewallRule_Transfer" Guid="*">
        <fire:FirewallException
          Id="TransferException"
          Name="Huanvae Chat LAN Transfer"
          Protocol="tcp"
          Port="53317"
          Profile="private"
          Scope="localSubnet"
          Description="Huanvae Chat 局域网文件传输" />
        <RegistryValue
          Root="HKCU"
          Key="Software\HuanvaeChat\Firewall"
          Name="Transfer"
          Type="integer"
          Value="1"
          KeyPath="yes" />
      </Component>
      
      <!-- 应用程序防火墙规则 -->
      <Component Id="FirewallRule_App" Guid="*">
        <fire:FirewallException
          Id="AppException"
          Name="Huanvae Chat App"
          Program="[INSTALLDIR]Huanvae-Chat-App.exe"
          Profile="private"
          Scope="localSubnet"
          Description="Huanvae Chat 应用程序" />
        <RegistryValue
          Root="HKCU"
          Key="Software\HuanvaeChat\Firewall"
          Name="App"
          Type="integer"
          Value="1"
          KeyPath="yes" />
      </Component>
      
    </ComponentGroup>
  </Fragment>
  
</Wix>
